{% extends "user/base.html" %}
{% load static %}
{% block content %}
<audio id="audio-correct" preload="auto">
    <source src="/media/audio/correct.mp3" type="audio/mpeg">
</audio>
<audio id="audio-wrong" preload="auto">
    <source src="/media/audio/ah.mp3" type="audio/mpeg">
</audio>
<div class="container pt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'student_courses' %}">Home</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <span>Revision</span>
            </li>
        </ol>
    </nav>
</div>
<div class="container mt-4">
    <div class="title-row">
        <h2>Revision</h2>
    </div>  
    <div class="row">
        <!-- Left Column: Welcome Block (8 columns) -->
        <div class="col-12 col-md-8 mb-4">
            <div id="welcomeBlock" class="text-center welcome-block p-4 mb-2 rounded">        
                {% if first_course %}
                    {% if first_course.revision_items_count > 0 %}
                        <h4 id="courseTitle">{{ first_course.title|escape }}</h4>
                        <p id="itemCount">There are <strong>{{ first_course.revision_items_count }}</strong> items due for revision.</p>
                        <button id="startButton" class="btn btn-success btn-lg mt-3">Start Revision</button>
                    {% else %}
                        <h4 id="courseTitle">{{ first_course.title|escape }}</h4>
                        <p id="itemCount">No items are due for revision at this moment.</p>
                        <p>You can do an overall revision of all items in this course.</p>
                        <button id="startOverallButton" class="btn btn-primary btn-lg mt-3">Start Revision</button>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info">
                        There are no items due for revision at this moment.
                        <br><a href="{% url 'student_courses' %}" class="alert-link">Go back to your courses</a>
                    </div>
                {% endif %}
            </div>
            <!-- Revision Container -->
            <div id="revisionContainer" class="flashcard-container d-none">
                {% if first_course %}
                <form id="revisionForm" method="post" action="{% url 'submit_revision' course_id=first_course.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="responses" id="responses">
                    <input type="hidden" name="is_completed" id="is_completed" value="false">
                </form>
                <div id="questions" class="questions-wrapper position-relative">
                    {% for item in first_course.revision_items %}
                    <div class="question-card d-none"
                         data-item-id="{{ item.id }}"
                         data-item-type="{{ item.item_type }}"
                         data-item-successes="{{ item.successes|default:0 }}"
                         data-item-correctanswer="{{ item.answer|escapejs }}"
                         data-item-is-master="{% if item.is_master %}true{% else %}false{% endif %}"
                         data-item-next1="{{ item.next_1|default:1 }}"
                         data-item-next2="{{ item.next_2|default:1 }}"
                         data-item-reviseat="{{ item.revise_at|default:'' }}"
                         data-item-continuerevision="{% if item.continue_revision %}true{% else %}false{% endif %}"
                         data-item-answer1="{{ item.answer1|escapejs }}"
                         data-item-answer2="{{ item.answer2|escapejs }}"
                         data-item-answer3="{{ item.answer3|escapejs }}"
                         data-item-answer4="{{ item.answer4|escapejs }}"
                         data-item-audioplay="{{ item.audio_play|default:'start' }}"
                         style="min-height: 60vh;">
                        <div class="question-content position-relative" style="flex-grow: 1;">
                            <center><h2 class="feedback-result d-none mb-3"></h2></center>
                            <div class="question-text fs-5 mb-2">
                                {{ item.question|safe }}
                            </div>
                            {% if item.image %}
                            <img src="{{ item.image }}" class="img-fluid mb-2" alt="Question image" style="max-height: 200px; object-fit: cover;">
                            {% endif %}
                            {% if item.audio %}
                            <div class="position-absolute top-0 end-0">
                                <i class="bi bi-volume-up fs-2 text-primary question-audio-icon" style="cursor: pointer;"></i>
                            </div>
                            <audio class="d-none" preload="auto">
                                <source src="{{ item.audio }}" type="audio/mpeg">
                            </audio>
                            {% endif %}
                            <div class="feedback-answer d-none mt-4 mb-3">
                                {% if item.audio %}
                                <div class="position-absolute top-0 end-0">
                                    <i class="bi bi-volume-up fs-2 text-primary feedback-audio-icon d-none" style="cursor: pointer;"></i>
                                </div>
                                {% endif %}
                                <p>The answer(s) are:</p>
                                <p class="correct-answer-text fs-5 text-primary"></p>
                            </div>
                        </div>
                        <div class="answer-buttons row g-2 mt-0" style="margin-top: auto;">
                            <div class="col-12 text-end mb-1">
                                <a href="#" class="skip-revision">Skip future revision</a>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-primary w-100 answer-btn"></button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-primary w-100 answer-btn"></button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-primary w-100 answer-btn"></button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-primary w-100 answer-btn"></button>
                            </div>
                        </div>
                        <div class="feedback-buttons d-none mt-3 d-flex justify-content-center gap-2" style="margin-top: auto;">
                            <button type="button" class="btn btn-primary continue-btn">Continue</button>
                            <button type="button" class="btn btn-secondary stop-btn">Stop</button>
                        </div>
                        <div class="fireworks d-none"></div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                <!-- Skip Revision Confirmation Modal -->
                <div class="modal fade" id="skipConfirmationModal" tabindex="-1" aria-labelledby="skipConfirmationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body text-center">
                                <h4 class="modal-title mb-3">Skip Revision</h4>
                                <p>Do you want to skip this item in future revisions?</p>
                                <div class="d-flex justify-content-center gap-2">
                                    <button type="button" class="btn btn-primary" id="skipConfirmButton">Yes</button>
                                    <button type="button" class="btn btn-secondary" id="skipCancelButton">No</button>
                                </div>        
                            </div>
                        </div>
                    </div>
                </div>
            </div>            
        </div>
        <!-- Right Column: Course List (4 columns) -->
        <div class="col-12 col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">My Courses</h6>
                </div>
                <div class="card-body p-0">
                    {% if courses %}
                    <ul class="list-group list-group-flush">
                        {% for course in courses %}
                        <li class="list-group-item course-item {% if course.id == first_course.id %}active{% endif %}"
                            data-course-id="{{ course.id }}"
                            data-title="{{ course.title|escapejs }}"
                            data-item-count="{{ course.revision_items_count|default:0 }}">
                            <a href="{% url 'revision' course_id=course.id %}" class="text-decoration-none d-flex justify-content-between course-link mt-1 mb-1">
                                {{ course.title }} <span class="badge bg-primary ms-2">{{ course.revision_items_count|default:0 }}</span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="p-3 text-muted">No courses available.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<style>
.welcome-block {
    border: 1px solid #ddd;
    border-radius: 8px;
    min-height: 50vh;
}
.welcome-block.d-none {
    display: none;
}
.flashcard-container.d-none {
    display: none;
}
.questions-wrapper, .flashcard-container {
    position: relative;
}
.question-card {
    min-height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    position: relative;
}
.question-content {
    flex-grow: 1;
}
.question-text {
    margin-right: 40px;
}
.answer-buttons {
    margin-top: auto;
}
.answer-buttons button {
    white-space: normal;
    min-height: 60px;
}
.feedback-buttons {
    margin-top: auto;
}
.correct-answer {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
}
.incorrect-answer {
    background-color: #f8d7da !important;
    border-color: #dc3545 !important;
}
.bi-volume-up {
    color: #0d6efd;
    cursor: pointer;
}
.bi-volume-up:hover {
    opacity: 0.8;
}
.progress-icon {
    font-size: 1em;
    margin: 0 2px;
}
.course-item {
    cursor: pointer;
}
.course-item.active {
    background-color: #e7f1ff;
    border-left: 3px solid #007bff !important;
    font-weight: 500;
}
.course-link {
    color: #212529;
}
.course-link:hover {
    color: #0d6efd;
}
.skip-revision {
    display: block;
    font-size: 1em;
    text-decoration: none;
}
.skip-revision:hover {
    text-decoration: underline;
}
.feedback-result.correct {
    color: #28a745;
}
.feedback-result.incorrect {
    color: #dc3545;
}
.fireworks {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 1000;
}
.firework-particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #ffd700;
    border-radius: 50%;
    animation: firework 1.5s ease-out forwards;
}
@keyframes firework {
    0% {
        transform: translate(0, 0);
        opacity: 1;
    }
    100% {
        transform: translate(var(--x), var(--y));
        opacity: 0;
    }
}
</style>
<script>
$(document).ready(function() {
    let dueItems = [];
    let otherItems = [];
    let revisedItems = [];
    let currentItem = null;
    let correctCount = 0;
    const MAX_ITEMS_PER_ROUND = 10;

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function initializeLists() {
        dueItems = [];
        otherItems = [];
        revisedItems = [];
        correctCount = 0;
        const now = new Date();
        $('.question-card').each(function() {
            const $card = $(this);
            const reviseAt = $card.data('item-reviseat');
            const continueRevision = String($card.data('item-continuerevision')) === 'true';
            const item = {
                id: $card.data('item-id'),
                item_type: $card.data('item-type'),
                successes: parseInt($card.data('item-successes') || 0),
                is_master: $card.data('item-is-master') === 'true',
                correctAnswer: $card.data('item-correctanswer'),
                next_1: parseInt($card.data('item-next1') || 1),
                next_2: parseInt($card.data('item-next2') || 1),
                revise_at: reviseAt || null,
                continue_revision: continueRevision,
                element: this,
                answer1: $card.data('item-answer1'),
                answer2: $card.data('item-answer2'),
                answer3: $card.data('item-answer3'),
                answer4: $card.data('item-answer4'),
                audio_play: $card.data('item-audioplay')
            };
            if (reviseAt && new Date(reviseAt) <= now && continueRevision) {
                dueItems.push(item);
            } else if (continueRevision) {
                otherItems.push(item);
            }
        });
        dueItems.sort((a, b) => {
            if (!a.revise_at) return 1;
            if (!b.revise_at) return -1;
            return new Date(a.revise_at) - new Date(b.revise_at);
        });
        if (dueItems.length === 0) {
            otherItems = shuffleArray(otherItems);
        } else {
            otherItems.sort((a, b) => a.successes - b.successes || a.id - b.id);
        }
        updateProgressIcons();
        dueItems.concat(otherItems).forEach(item => reshuffleOptions(item));
    }

    function processNextItem() {
        if (revisedItems.length >= MAX_ITEMS_PER_ROUND) {
            saveProgress(true);
            return;
        }
        if (dueItems.length > 0) {
            currentItem = dueItems.shift();
        } else if (otherItems.length > 0) {
            currentItem = otherItems.shift();
            otherItems.push(currentItem);
        } else {
            saveProgress(true);
            return;
        }
        if (currentItem) {
            showItem(currentItem);
            $('.answer-btn').removeClass('selected-answer correct-answer incorrect-answer');
            const $card = $(currentItem.element);
            $card.find('.feedback-result, .feedback-answer, .feedback-buttons, .feedback-audio-icon').addClass('d-none');
            $card.find('.question-text, .answer-buttons, .question-audio-icon, img').removeClass('d-none');
            $card.removeClass('d-none');
        } else {
            saveProgress(true);
        }
    }

    function showItem(item) {
        $('.question-card').addClass('d-none');
        $(item.element).removeClass('d-none');
        const audioElement = $(item.element).find('audio')[0];
        if (audioElement && (item.audio_play === 'start' || item.audio_play === 'both')) {
            audioElement.currentTime = 0;
            audioElement.play();
        }
    }

    function reshuffleOptions(item) {
        let options;
        if (item.item_type === 'mc') {
            options = [
                item.correctAnswer,
                item.answer1 || 'Option A',
                item.answer2 || 'Option B',
                item.answer3 || 'Option C',
                item.answer4 || 'Option D'
            ].filter(opt => opt);
        } else {
            const allItems = $('.question-card').map(function() {
                return { answer: $(this).data('item-correctanswer') };
            }).get();
            const correctAnswer = item.correctAnswer;
            let wrongAnswers = allItems
                .map(i => i.answer)
                .filter(answer => answer !== correctAnswer && answer);
            if (wrongAnswers.length > 3) {
                wrongAnswers = shuffleArray(wrongAnswers).slice(0, 3);
            } else if (wrongAnswers.length < 3) {
                const placeholders = ["Option A", "Option B", "Option C"];
                wrongAnswers = wrongAnswers.concat(
                    placeholders.slice(0, 3 - wrongAnswers.length)
                );
            }
            options = [correctAnswer, ...wrongAnswers];
        }
        shuffleArray(options);
        const $buttons = $(item.element).find('.answer-btn');
        $buttons.each(function(index) {
            $(this).text(options[index] || '');
            $(this).data('correct', options[index] === item.correctAnswer);
            $(this).removeClass('selected-answer correct-answer incorrect-answer');
        });
    }

    function updateProgressIcons() {
        const progressIcons = $('.progress-icons').empty();
        for (let i = 0; i < correctCount; i++) {
            progressIcons.append('<i class="bi bi-check-circle-fill progress-icon text-success"></i>');
        }
        for (let i = correctCount; i < MAX_ITEMS_PER_ROUND; i++) {
            progressIcons.append('<i class="bi bi-circle progress-icon text-secondary"></i>');
        }
        $('.correct-count').text(`${correctCount}/${MAX_ITEMS_PER_ROUND}`);
    }

    function showFireworks($card) {
        const $fireworks = $card.find('.fireworks').empty().removeClass('d-none');
        const count = 50;
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        for (let i = 0; i < count; i++) {
            const startX = Math.random() * vw;
            const startY = Math.random() * vh;
            const angle = Math.random() * Math.PI * 2;
            const distance = 100 + Math.random() * 300;
            const $particle = $('<div class="firework-particle"></div>').css({
                left: `${startX}px`,
                top: `${startY}px`,
                '--x': `${Math.cos(angle) * distance}px`,
                '--y': `${Math.sin(angle) * distance}px`,
                background: ['#ffd700', '#ff4500', '#00ff00', '#00b7eb'][Math.floor(Math.random() * 4)]
            });
            $fireworks.append($particle);
        }
        setTimeout(() => $fireworks.addClass('d-none'), 1500);
    }

    function showFeedback(isCorrect, correctAnswer) {
        const $card = $(currentItem.element);
        const $feedbackResult = $card.find('.feedback-result');
        const $feedbackAnswer = $card.find('.feedback-answer');
        const $correctAnswerText = $card.find('.correct-answer-text');
        const $feedbackButtons = $card.find('.feedback-buttons');
        const $answerButtons = $card.find('.answer-buttons');
        const $questionElements = $card.find('.answer-buttons, .question-audio-icon, img');
        const $feedbackAudioIcon = $card.find('.feedback-audio-icon');
        const audioElement = $card.find('audio')[0];
        const feedbackAudio = isCorrect ? document.getElementById('audio-correct') : document.getElementById('audio-wrong');

        // Show feedback elements immediately
        $questionElements.addClass('d-none');
        $feedbackResult.text(isCorrect ? 'Correct!' : 'Incorrect!').addClass(isCorrect ? 'correct' : 'incorrect').removeClass('d-none');
        $correctAnswerText.html(isCorrect ? correctAnswer : `<strong>${correctAnswer}</strong>`);
        $feedbackAnswer.removeClass('d-none');
        $feedbackButtons.removeClass('d-none');
        $card.find('.question-text').removeClass('d-none');
        if (audioElement) {
            $feedbackAudioIcon.removeClass('d-none');
        }
        if (isCorrect) {
            showFireworks($card);
        }

        // Play feedback audio, then item audio if applicable
        feedbackAudio.currentTime = 0;
        feedbackAudio.play();
        feedbackAudio.onended = () => {
            if (audioElement && (currentItem.audio_play === 'end' || currentItem.audio_play === 'both')) {
                audioElement.currentTime = 0;
                audioElement.play();
            }
        };

        // Clear previous event handlers to prevent duplicates
        $card.find('.continue-btn').off('click');
        $card.find('.stop-btn').off('click');

        if (revisedItems.length >= MAX_ITEMS_PER_ROUND) {
            $card.find('.continue-btn').hide();
            $card.find('.stop-btn').text('Finish').show().on('click', () => {
                saveProgress(true);
            });
        } else if (isCorrect) {
            $card.find('.continue-btn').text('Continue').show().on('click', () => {
                processNextItem();
            });
            $card.find('.stop-btn').text('Stop').show().on('click', () => {
                saveProgress();
            });
        } else {
            $card.find('.continue-btn').text('Try Again').show().on('click', () => {
                reshuffleOptions(currentItem);
                $card.find('.feedback-result, .feedback-answer, .feedback-buttons, .feedback-audio-icon').addClass('d-none');
                $card.find('.question-text, .answer-buttons, .question-audio-icon, img').removeClass('d-none');
                // Play audio on retry if audio_play is 'start' or 'both'
                const audioElement = $card.find('audio')[0];
                if (audioElement && (currentItem.audio_play === 'start' || currentItem.audio_play === 'both')) {
                    audioElement.currentTime = 0;
                    audioElement.play();
                }
            });
            $card.find('.stop-btn').text('Stop').show().on('click', () => {
                saveProgress();
            });
        }
    }

    function saveProgress(isCompleted = false) {
        const responses = revisedItems.map(item => ({
            student_item_id: item.id,
            successes: item.successes,
            next_1: item.next_1,
            next_2: item.next_2,
            revise_at: item.revise_at,
            continue_revision: item.continue_revision
        }));
        $('#responses').val(JSON.stringify(responses));
        $('#is_completed').val(isCompleted);
        $.ajax({
            url: $('#revisionForm').attr('action'),
            method: 'POST',
            data: $('#revisionForm').serializeArray(),
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
            },
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    $('#itemCount').html(`There are <strong>${response.stats.remaining_items}</strong> items due for revision.`);
                    $('#revisionContainer').addClass('d-none');
                    $('#welcomeBlock').removeClass('d-none');
                    $('#welcomeBlock').prepend(
                        `<div class="alert alert-success mb-3">${response.message}</div>`
                    );
                    if (response.redirect_url) {
                        window.location.href = response.redirect_url;
                    }
                } else {
                    alert('Error saving progress: ' + (response.message || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                alert('Error saving progress: ' + (xhr.responseJSON?.message || 'Unknown error'));
            }
        });
    }

    function handleAnswer(isCorrect, $button) {
        $('.answer-btn').removeClass('selected-answer correct-answer incorrect-answer');
        $button.addClass('selected-answer ' + (isCorrect ? 'correct-answer' : 'incorrect-answer'));
        
        if (isCorrect) {
            correctCount++;
            currentItem.successes += 1;
            
            const now = new Date();
            const reviseAt = currentItem.revise_at ? new Date(currentItem.revise_at) : null;
            
            if (!reviseAt || now > reviseAt) {
                let temp = currentItem.next_2;
                currentItem.next_2 = currentItem.next_1 + currentItem.next_2;
                currentItem.next_1 = temp;
                
                const newReviseAt = new Date(now.setDate(now.getDate() + currentItem.next_2));
                currentItem.revise_at = newReviseAt.toISOString();
            }
            
            currentItem.is_master = currentItem.successes >= 3;
            revisedItems.push(currentItem);
            showFeedback(isCorrect, currentItem.correctAnswer);
        } else {
            if (currentItem.revise_at && new Date(currentItem.revise_at) <= new Date()) {
                dueItems.unshift(currentItem);
            } else {
                otherItems.unshift(currentItem);
            }
            showFeedback(isCorrect, currentItem.correctAnswer);
        }
    }

    $('#startButton').click(function() {
        initializeLists();
        $('#welcomeBlock').addClass('d-none');
        $('#revisionContainer').removeClass('d-none');
        processNextItem();
    });

    $('#startOverallButton').click(function() {
        initializeLists();
        $('#welcomeBlock').addClass('d-none');
        $('#revisionContainer').removeClass('d-none');
        processNextItem();
    });

    $(document).on('click', '.answer-btn', function() {
        const isCorrect = $(this).data('correct');
        handleAnswer(isCorrect, $(this));
    });

    $(document).on('click', '.question-audio-icon', function() {
        const audioElement = $(this).closest('.question-content').find('audio')[0];
        if (audioElement) {
            audioElement.currentTime = 0;
            audioElement.play();
        }
    });

    $(document).on('click', '.feedback-audio-icon', function() {
        const audioElement = $(this).closest('.question-content').find('audio')[0];
        if (audioElement) {
            audioElement.currentTime = 0;
            audioElement.play();
        }
    });

    $(document).on('click', '.skip-revision', function(e) {
        e.preventDefault();
        if (currentItem) {
            $('#skipConfirmationModal').modal('show');
        }
    });

    $('#skipConfirmButton').click(function() {
        if (currentItem) {
            currentItem.continue_revision = false;
            revisedItems.push(currentItem);
            $(currentItem.element).attr('data-item-continuerevision', 'false');
        }
        $('#skipConfirmationModal').modal('hide');
        processNextItem();
    });

    $('#skipCancelButton').click(function() {
        $('#skipConfirmationModal').modal('hide');
    });
});
</script>
{% endblock %}