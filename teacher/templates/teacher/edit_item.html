{% extends "user/base.html" %}
{% load static %}
{% block content %}
<div class="container pt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'teacher:manage_courses' %}">Manage Courses</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'teacher:manage_lessons' activity.lesson.course.id %}">Lessons</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'teacher:manage_activities' activity.lesson.id %}">Activities</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'teacher:manage_items' activity.id %}">Items</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Edit Item
            </li>
        </ol>
    </nav>
</div>
<div class="container mt-5">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">{% if item.id %}Edit Item{% else %}New Item{% endif %}</h4>
        </div>
        <div class="card-body">
            <form id="itemForm" method="POST" action="{% url 'teacher:edit_item' activity.id item.id|default:0 %}" enctype="multipart/form-data">
                {% csrf_token %}
                {% if error %}
                <div class="alert alert-danger mb-3">{{ error }}</div>
                {% endif %}
                <input type="hidden" name="number_answers" id="id_number_answers" value="{{ form.number_answers.value|default_if_none:'1' }}">
                <div class="row">
                    <div class="col-md-5 mb-3">
                        <label for="id_title" class="form-label">Item Title</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="invalid-feedback d-block">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="id_item_type" class="form-label">Item Type</label>
                        {{ form.item_type }}
                        {% if form.item_type.errors %}
                        <div class="invalid-feedback d-block">{{ form.item_type.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="id_item_category" class="form-label">Item Category</label>
                        {{ form.item_category }}
                        {% if form.item_category.errors %}
                        <div class="invalid-feedback d-block">{{ form.item_category.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="id_question" class="form-label">Question</label>
                        {{ form.question }}
                        <small id="blank-count-feedback" class="form-text text-muted"></small>
                        {% if form.question.errors %}
                        <div class="invalid-feedback d-block">{{ form.question.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3" id="dynamic-field">
                        <div id="answer-field" class="hidden">
                            <label for="id_answer" class="form-label">Correct Answer</label>
                            {{ form.answer }}
                            {% if form.answer.errors %}
                            <div class="invalid-feedback d-block">{{ form.answer.errors }}</div>
                            {% endif %}
                        </div>
                        <div id="number-answers-field" class="hidden">
                            <label for="id_number_answers_display" class="form-label">Number of Blanks</label>
                            <input type="number" id="id_number_answers_display" class="form-control" readonly value="{{ form.number_answers.value|default_if_none:'1' }}">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3" id="answer1-field">
                        <label for="id_answer1" class="form-label">Answer 1</label>
                        {{ form.answer1 }}
                        {% if form.answer1.errors %}
                        <div class="invalid-feedback d-block">{{ form.answer1.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3" id="answer2-field">
                        <label for="id_answer2" class="form-label">Answer 2</label>
                        {{ form.answer2 }}
                        {% if form.answer2.errors %}
                        <div class="invalid-feedback d-block">{{ form.answer2.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3" id="answer3-field">
                        <label for="id_answer3" class="form-label">Answer 3</label>
                        {{ form.answer3 }}
                        {% if form.answer3.errors %}
                        <div class="invalid-feedback d-block">{{ form.answer3.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3" id="answer4-field">
                        <label for="id_answer4" class="form-label">Answer 4</label>
                        {{ form.answer4 }}
                        {% if form.answer4.errors %}
                        <div class="invalid-feedback d-block">{{ form.answer4.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Image</label>
                        <div id="image-dropzone" class="dropzone" tabindex="0"></div>
                        {% if item.image %}
                            <div class="mt-2">
                                <small>Current image: <a href="{{ item.image.url }}" target="_blank">View</a></small>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="id_audio" class="form-label">Audio</label>
                        {{ form.audio }}
                        {% if item.audio %}
                        <div class="mt-2">
                            <small>Current audio: <a href="{{ item.audio.url }}" target="_blank">Listen</a></small>
                        </div>
                        {% endif %}
                        {% if form.audio.errors %}
                        <div class="invalid-feedback d-block">{{ form.audio.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3" id="audio-play-field">
                        <label for="id_audio_play" class="form-label">Audio Playback</label>
                        {{ form.audio_play }}
                        {% if form.audio_play.errors %}
                        <div class="invalid-feedback d-block">{{ form.audio_play.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="id_order" class="form-label">Order</label>
                        {{ form.order }}
                        {% if form.order.errors %}
                        <div class="invalid-feedback d-block">{{ form.order.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <a href="{% url 'teacher:manage_items' activity.id %}" class="btn btn-secondary">Cancel</a>
                    <button id="submit-btn" type="submit" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />
<style>
    .form-label { font-weight: 500; }
    .card { max-width: 800px; margin: 0 auto; }
    .form-control, .form-select { width: 100%; }
    .dropzone { min-height: 150px; border: 2px dashed #ccc; padding: 20px; background: #fafafa; }
    .hidden { display: none; }
    #id_number_answers_display { background-color: #f8f9fa; cursor: not-allowed; }
</style>
{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script>
Dropzone.autoDiscover = false;
document.addEventListener('DOMContentLoaded', function() {
    var dropzoneElement = document.getElementById('image-dropzone');
    var isHovering = false;
    dropzoneElement.setAttribute('tabindex', '0');
    dropzoneElement.addEventListener('mouseenter', function() {
        isHovering = true;
        dropzoneElement.style.backgroundColor = '#e0e0e0';
        dropzoneElement.focus();
    });
    dropzoneElement.addEventListener('mouseleave', function() {
        isHovering = false;
        dropzoneElement.style.backgroundColor = '';
    });
    var dropzone = new Dropzone("#image-dropzone", {
        url: "{% url 'teacher:edit_item' activity.id item.id|default:0 %}",
        paramName: "image",
        maxFiles: 1,
        acceptedFiles: ".jpeg,.jpg,.png,.gif",
        maxFilesize: 5,
        addRemoveLinks: true,
        autoProcessQueue: false,
        dictDefaultMessage: "Drag & drop an image here, click to select, or paste (Ctrl+V) your image.",
        previewsContainer: "#image-dropzone",
        clickable: true,
        init: function() {
            var dz = this;
            var form = document.getElementById("itemForm");
            var submitBtn = document.getElementById("submit-btn");
            submitBtn.addEventListener("click", function(e) {
                if (dz.getQueuedFiles().length) {
                    e.preventDefault();
                    dz.processQueue();
                } else {
                    form.submit();
                }
            });
            dz.on("sending", function(file, xhr, formData) {
                var formElements = form.querySelectorAll("input:not([type='file']):not([type='submit']), textarea, select");
                formElements.forEach(function(el) {
                    formData.append(el.name, el.value);
                });
                var audioInput = document.getElementById('id_audio');
                if (audioInput.files.length > 0) {
                    formData.append('audio', audioInput.files[0]);
                }
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            });
            dz.on("success", function(file, response) {
                window.location.href = "{% url 'teacher:manage_items' activity.id %}";
            });
            dz.on("error", function(file, errorMessage) {
                alert(errorMessage);
            });
        }
    });
    document.addEventListener('paste', function(e) {
        if (
            isHovering &&
            e.clipboardData &&
            e.clipboardData.files &&
            e.clipboardData.files.length
        ) {
            var file = e.clipboardData.files[0];
            dropzone.addFile(file);
        }
    });
    // Dynamic field visibility and number_answers calculation for blank items
    var itemTypeSelect = document.getElementById('id_item_type');
    var questionInput = document.getElementById('id_question');
    var numberAnswersInput = document.getElementById('id_number_answers');
    var numberAnswersDisplay = document.getElementById('id_number_answers_display');
    var numberAnswersField = document.getElementById('number-answers-field');
    var blankCountFeedback = document.getElementById('blank-count-feedback');
    var answerField = document.getElementById('answer-field');
    var dynamicField = document.getElementById('dynamic-field');
    var answer1Field = document.getElementById('answer1-field');
    var answer2Field = document.getElementById('answer2-field');
    var answer3Field = document.getElementById('answer3-field');
    var answer4Field = document.getElementById('answer4-field');
    var audioField = document.getElementById('id_audio');
    var audioPlayField = document.getElementById('audio-play-field');
    var hasAudio = {% if item.audio %}true{% else %}false{% endif %};
    function updateFields() {
        var itemType = itemTypeSelect.value;
        // Reset visibility and required attributes
        answerField.classList.add('hidden');
        numberAnswersField.classList.add('hidden');
        answer1Field.classList.add('hidden');
        answer2Field.classList.add('hidden');
        answer3Field.classList.add('hidden');
        answer4Field.classList.add('hidden');
        document.getElementById('id_answer').required = false;
        document.getElementById('id_answer1').required = false;
        document.getElementById('id_answer2').required = false;
        document.getElementById('id_answer3').required = false;
        document.getElementById('id_answer4').required = false;
        blankCountFeedback.textContent = '';
        if (itemType === 'card' || itemType === 'mc') {
            numberAnswersInput.value = 1; // Set number_answers to 1 for card and mc
            numberAnswersDisplay.value = 1;
            answerField.classList.remove('hidden');
            dynamicField.classList.remove('hidden');
            document.getElementById('id_answer').required = true;
            if (itemType === 'mc') {
                answer1Field.classList.remove('hidden');
                answer2Field.classList.remove('hidden');
                answer3Field.classList.remove('hidden');
                answer4Field.classList.remove('hidden');
                document.getElementById('id_answer1').required = true;
                document.getElementById('id_answer2').required = true;
                document.getElementById('id_answer3').required = true;
                document.getElementById('id_answer4').required = true;
            }
        } else if (itemType === 'blank') {
            dynamicField.classList.remove('hidden');
            answer1Field.classList.remove('hidden');
            answer2Field.classList.remove('hidden');
            answer3Field.classList.remove('hidden');
            answer4Field.classList.remove('hidden');
            // Normalize underscores for blank items
            var questionText = questionInput.value || '';
            var normalizedText = questionText.replace(/_{3,}/g, '____');
            if (questionText !== normalizedText) {
                questionInput.value = normalizedText;
            }
            // Count sequences of 4 underscores (after normalization)
            var underscoreCount = (normalizedText.match(/____/g) || []).length;
            var numAnswers = Math.max(1, underscoreCount); // Ensure at least 1
            numberAnswersInput.value = numAnswers;
            numberAnswersDisplay.value = numAnswers;
            numberAnswersField.classList.remove('hidden');
            blankCountFeedback.textContent = underscoreCount > 0
                ? `Detected ${underscoreCount} blank(s) (3 or more underscores normalized to ____). Number of answers set to ${numAnswers}.`
                : 'No blanks detected. Use 3 or more underscores (e.g., ___) for each blank. Number of answers set to 1.';
            // Set required attributes based on number of blanks
            document.getElementById('id_answer1').required = numAnswers >= 1;
            document.getElementById('id_answer2').required = numAnswers >= 2;
            document.getElementById('id_answer3').required = numAnswers >= 3;
            document.getElementById('id_answer4').required = numAnswers >= 4;
        } else {
            numberAnswersInput.value = 1; // Default to 1 for unknown types
            numberAnswersDisplay.value = 1;
            dynamicField.classList.add('hidden');
        }
        updateAudioPlayRequirement();
    }
    function updateAudioPlayRequirement() {
        var audioPlayInput = document.getElementById('id_audio_play');
        var isRequired = hasAudio || audioField.files.length > 0;
        audioPlayInput.required = isRequired;
    }
    // Initialize fields based on current item_type and question
    updateFields();
    itemTypeSelect.addEventListener('change', updateFields);
    questionInput.addEventListener('input', updateFields);
    questionInput.addEventListener('paste', function() {
        setTimeout(updateFields, 0);
    });
});
</script>
{% endblock %}