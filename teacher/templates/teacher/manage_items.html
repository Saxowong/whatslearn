{% extends "user/base.html" %}
{% load static %}

{% block content %}
<div class="container pt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'teacher:manage_courses' %}">Manage Courses</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'teacher:manage_lessons' activity.lesson.course.id %}">Lessons</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'teacher:manage_activities' activity.lesson.id %}">Activities</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Items
            </li>
        </ol>
    </nav>
</div>
<div class="container mt-5">
    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ activity.title }}</h2>
        <div>
            <button type="submit" form="reorderForm" class="btn btn-primary me-2" id="saveOrderBtn" aria-label="Save item order">
                <i class="bi bi-save"></i> Save Order
            </button>
            <a href="{% url 'teacher:edit_item' activity.id 0 %}" class="btn btn-success me-2" aria-label="Add new item">
                <i class="bi bi-plus-lg"></i> New Item
            </a>
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#importItemsModal" aria-label="Import items">
                <i class="bi bi-upload"></i> Import Items
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="reorderForm" method="POST" action="{% url 'teacher:manage_items' activity.id %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="reorder">
                <table id="itemsTable" class="table table-striped" aria-label="Items table">
                    <thead>
                        <tr>
                            <th>Order</th>
                            <th>Item Title</th>
                            <th>Question</th>
                            <th>Answer</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-item-id="{{ item.id }}">
                            <td class="editable-order" data-order="{{ item.order|default:'0' }}">
                                <span class="order-value">{{ item.order|default:"0" }}</span>
                                <input type="hidden" name="order_{{ item.id }}" class="order-input" value="{{ item.order|default:'0' }}">
                            </td>
                            <td>{{ item.title|default:"Untitled" }}</td>
                            <td>{{ item.question|truncatechars:50|default:"N/A" }}</td>
                            <td>{{ item.answer|default:"N/A" }}</td>
                            <td data-sort="{{ item.created_at|date:'c'|default:'1970-01-01T00:00:00Z' }}">{{ item.created_at|date:"Y-m-d H:i:s"|default:"N/A" }}</td>
                            <td>
                                <a href="{% url 'teacher:edit_item' activity.id item.id %}" class="btn btn-sm btn-primary" aria-label="Edit item">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-warning delete-item-btn" 
                                        data-item-id="{{ item.id }}" data-item-title="{{ item.title|default:'Untitled'|escapejs }}"
                                        data-bs-toggle="modal" data-bs-target="#deleteItemModal" aria-label="Delete item">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td></td>
                            <td>No items found</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
    </div>

    <!-- Delete Item Modal -->
    <div class="modal fade" id="deleteItemModal" tabindex="-1" aria-labelledby="deleteItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteItemModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="deleteItemForm" method="POST" action="">
                    {% csrf_token %}
                    <div class="modal-body">
                        Are you sure you want to delete the item "<span id="itemTitle"></span>"?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmDeleteItemBtn">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Import Items Modal -->
    <div class="modal fade" id="importItemsModal" tabindex="-1" aria-labelledby="importItemsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importItemsModalLabel">Import Items</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="importItemsForm" method="POST" action="{% url 'teacher:import_items' activity.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="zip_file" class="form-label">ZIP File</label>
                            <input type="file" class="form-control" id="zip_file" name="zip_file" accept=".zip" required>
                            <br/>
                            <small class="form-text text-muted">Upload a ZIP file which contain the following items:<ol><li>An <b>items.xlsx</b> file (with columns: title, question, answer, image_filename, audio_filename)<li>Optional image (JPG/PNG) and audio (MP3) files.</ol></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Import</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
<style>
    .badge {
        font-size: 0.9em;
        min-width: 2.5em;
        padding: 0.3em 0.6em;
    }
    th.sorting:after, th.sorting_asc:after, th.sorting_desc:after {
        opacity: 0.8 !important;
    }
    .dataTables_wrapper .dataTables_filter input {
        margin-left: 0.5em;
    }
    .editable-order:hover {
        cursor: pointer;
        background-color: #f8f9fa;
    }
    .editable-order input {
        width: 100%;
        border: none;
        background: transparent;
        padding: 0;
        font-size: inherit;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

<script>
$(document).ready(function() {
    try {
        const table = $('#itemsTable').DataTable({
            dom: '<"row"<"col-md-6"B><"col-md-6"f>>rt<"row"<"col-md-6"i><"col-md-6"p>>',
            buttons: [
                {
                    extend: 'excelHtml5',
                    className: 'btn btn-sm btn-outline-success',
                    exportOptions: { columns: [0, 1, 2, 3, 4] }
                },
                {
                    extend: 'pdfHtml5',
                    className: 'btn btn-sm btn-outline-danger',
                    title: 'Items for {{ activity.title|default:"Activity"|escapejs }} - {{ request.user.get_full_name|default:request.user.username|escapejs }}',
                    exportOptions: { columns: [0, 1, 2, 3, 4] }
                }
            ],
            responsive: true,
            order: [[0, 'asc']], // Sort by Order column (now index 0)
            columnDefs: [
                {
                    targets: [4], // Created At column (now index 4)
                    render: function(data, type) {
                        if (type === 'display') {
                            if (!data || data === 'N/A') return 'N/A';
                            try {
                                const date = new Date(data);
                                return isNaN(date.getTime()) ? 'N/A' : date.toLocaleString('en-US', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                    hour: 'numeric',
                                    minute: 'numeric',
                                    second: 'numeric'
                                });
                            } catch (e) {
                                console.error('Date rendering error:', e);
                                return 'N/A';
                            }
                        }
                        return data || '1970-01-01T00:00:00Z';
                    }
                },
                {
                    targets: 0, // Order column (now index 0)
                    render: function(data, type, row) {
                        if (type === 'display') {
                            return `<span class="order-value">${data}</span>`;
                        }
                        return data;
                    }
                },
                {
                    targets: -1, // Actions column (still last)
                    orderable: false,
                    searchable: false
                }
            ],
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search items...",
                emptyTable: "No items found for this activity."
            },
            initComplete: function() {
                $('.dataTables_filter input').addClass('form-control form-control-sm');
                console.log('DataTable initialized');
            }
        });

        // Inline editing for order column
        $(document).on('click', '.editable-order', function() {
            try {
                const $cell = $(this);
                if ($cell.find('input:not([type="hidden"])').length > 0) return;
                const currentValue = $cell.data('order') || 0;
                const itemId = $cell.closest('tr').data('item-id');
                const $input = $('<input type="number" min="0" class="form-control form-control-sm">').val(currentValue);
                $cell.find('.order-value').replaceWith($input);
                $input.focus();

                $input.on('blur', function() {
                    const inputVal = $input.val();
                    const newValue = isNaN(parseInt(inputVal)) ? currentValue : parseInt(inputVal);
                    $cell.data('order', newValue);
                    $cell.find('.order-input').val(newValue);
                    $cell.html(`<span class="order-value">${newValue}</span><input type="hidden" name="order_${itemId}" class="order-input" value="${newValue}">`);
                    console.log(`Order updated for item ${itemId}: ${newValue}`);
                });

                $input.on('keypress', function(e) {
                    if (e.which === 13) {
                        $input.blur();
                    }
                });
            } catch (e) {
                console.error('Inline editing error:', e);
            }
        });

        // Delete item handler
        $(document).on('click', '.delete-item-btn', function() {
            try {
                const itemId = $(this).data('item-id');
                const itemTitle = $(this).data('item-title');
                $('#itemTitle').text(itemTitle);
                $('#deleteItemForm').attr('action', `{% url 'teacher:delete_item' 0 %}`.replace('0', itemId));
                console.log('Delete button clicked for item:', itemId);
            } catch (e) {
                console.error('Delete button error:', e);
            }
        });
    } catch (e) {
        console.error('DataTable initialization error:', e);
    }
});
</script>
{% endblock %}